<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SkypeKit C++ Wrapper Reference: Threading</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="islander3.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Threading </h1>  </div>
</div>
<div class="contents">
<p>First, a brief list of things you wish you shouldn't have to know about threads in the C++ Wrapper. <br/>
 1. SkypeKit API methods can be safely called from your application main thread (the thread in which Skype::init method was called); <br/>
 2. SkypeKit API callbacks (event and property update callback code) do not execute in your application main thread. <br/>
 3. Nevertheless, SkypeKit API methods can be callled from SkypeKit API callbacks as well. <br/>
 4. Calling API methods from multiple application threads is currently not supported. <br/>
 5. There are a few exceptions to the rule 3 - there are 4 callbacks in which calling API methods is not safe. There is a list below.</p>
<p>The reason for the main thread restriction is that SkypeKit API calls are blocking and asynchronous at the same time. All SkypeKit API methods are remote procedure calls, with execution point in runtime. As the remote procedure call gets passed to the runtime, application thread is put on hold, blocking, until a reply comes back from the runtime side. The wrapper then needs to resume the thread that initiated the call, with new data received from the runtime. For this, the wrapper needs to know which thread to resume. For this to work, you would need to actively maintain the list of API-accessing threads for the wrapper. There are currently no easy tools in the wrapper for you to do so. In future versions, we may expand this so that multiple calling threads could be supported.</p>
<p>With events and property updates, things get a bit more complicated. These are initiated in the runtime and passed to the wrapper. The wrapper has a thread pool for handling such incoming events. Every incoming property update or event callback is executed in one of such threads. Again, incoming property updates and events are handled in separate threads. This means that you will most likely be unable to do GUI updates from such callbacks directly and will need to use appropriate UI synchronization mechanisms. The good news is that you can call other SkypeKit API methods from event/update callbacks.</p>
<p>By default, the wrapper thread pool size is 1. The size can be changed by passing an argument to the <a class="el" href="class_skype.html" title="The main class that exposes Skype-related functionality to your application. Currently the SDK only s...">Skype</a> class constructor. It is important to understand that setting the thread pool size higher than 1 can break strict sequentiality of events and property updates. In case of property updates, this should not be an issue - as there is only the single OnChange callback for all the properties, you are in any case retrieving the updated value form property cache. The property cache will be updated sequentially regardless of how many threads the wrapper is running. It is only the callbacks that may get fired out of order.</p>
<p>It is also possible to set the thread pool size to zero, forcing completely flat treading model. This would make it somewhat easier to write your UI code - as there would be no need to synchronize GUI updates from within event and property callbacks. On the other hand, this would place restrictions on how long your application can spendd time in such callbacks. Long callbacks could render your application UI less responsive.</p>
<p>In case of flat threading, the wrapper does no event polling on its own and you will need to implement your own protocol loop. Example of this can be found in the command-line skypektclient appllication (in interfaces/skype/cpp_embedded/src/client/cskype.h</p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">int</span> get_socket_fd() {
    <span class="keywordflow">return</span> m_connection-&gt;get_id();
}

<span class="keywordtype">int</span> process_events(<span class="keywordtype">int</span> polled) { <span class="comment">// polled = true if there is data in socket_fd </span>
    <span class="keywordflow">while</span> (polled || m_protocol-&gt;has_buffered_event()) { <span class="comment">// or if (polled || has_buffered_events()) : then select loop will be called between each event processing</span>
        process_command(m_main_command_initiator);
        polled = 0;
    }
    <span class="keywordflow">return</span> is_server_connected();
}
</pre></div><p>Finally, there are some callbacks in which calling of SkypeKit API methods is not allowed. Unlike other callbacks, these get executed in the main application thread. These events are: </p>
<ul>
<li>Skype::Disconnected </li>
<li>Skype::Connected, </li>
<li>Skype::Connecting </li>
<li>Skype::OnError</li>
</ul>
<p>The reason for this is that these are not parts of the "natural" SkypeKit API. These are parts of the local (runtime-app) data transport system and are thus handled somewhat differently.</p>
<p>And the last exception - Skype::stop(). Skype::stop method is special in a way that it forces all the active event and property update callback threads to join with the main application thread. This changes the situation with treading - as it causes all the incoming update callbacks to be fired in the application thread (instead a thread from wrapper thread pool). This situation should not normally happen - it is expected that Skype::stop is only called after current <a class="el" href="class_account.html" title="Represents a local account. Encapsulates methods for Skype account creation, login and logout as well...">Account</a> has been logged out and thus no more incoming traffic from runtime can happen. </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


<hr/>	
		<p><b>(c) Skype Technologies S.A. Confidential/Proprietary</b></p>		
		<p>Last updated: Fri Oct 7 2011</p>		
		</BODY>
</HTML>
