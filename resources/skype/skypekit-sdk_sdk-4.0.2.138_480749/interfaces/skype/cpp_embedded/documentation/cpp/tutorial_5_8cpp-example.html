<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SkypeKit C++ Wrapper Reference: tutorial_5.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="islander3.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>tutorial_5.cpp</h1>  </div>
</div>
<div class="contents">
<h2><a class="anchor" id="Step5"></a>
C++ Tutorial Step 5: Picking up incoming calls and catching voice activity notifications</h2>
<p>In this step of the tutorial, we finally get around to voice calls. We'll write a small SkypeKit client that </p>
<ul>
<li>selects an audio device. </li>
<li>waits for incoming calls </li>
<li>picks them up </li>
<li>if there's audio coming in from any of the remote parties, prints audio volume levels</li>
</ul>
<h3><a class="anchor" id="Step5Walkthrough"></a>
Code Walkthrough</h3>
<p>To pick up incoming calls, we will basically need to detect when a <a class="el" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8f">Conversation::LOCAL_LIVESTATUS</a> property gets changed to <a class="el" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8fa123514d0921715cb2882899c32dd44fe">Conversation::RINGING_FOR_ME</a> and then call JoinLiveSession() method of that object. In reality however, it is somewhat more complicated than that.</p>
<p>Firstly, there is the obvious issue of possibility of another live conversation being up already. Live conversations with more than two participants will be covered in another tutorial, so in this case we will just ignore other incoming calls in such cases. It would also be nice to display the list of remote participants. It's a list - not single remote participant - because it could be the case that you were invited to an already existing voice conference.</p>
<p>To do all that, lets introduce our own version of <a class="el" href="class_conversation.html#aaa977e4808c8a5a57b90688f3635dc7b">Conversation::JoinLiveSession</a> and name it PickUpCall.</p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">void</span> MyConversation::PickUpCall()
{
  <span class="comment">// CallerList we keep in Conversation class - so that it won&#39;t get garbage collected</span>
  <span class="comment">// while the conversation object exists in the wrapper. </span>
  this-&gt;GetParticipants(callerList, <a name="a0"></a><a class="code" href="class_conversation.html#a3b9a94385c62856673e211120ea2ca7badaf9ba258a630895b4eb1055ad619adf">Conversation::OTHER_CONSUMERS</a>);
  <a name="_a1"></a><a class="code" href="class_s_e_string.html" title="SEString is basic char* based string class.">SEString</a> partListAsString = <span class="stringliteral">&quot;&quot;</span>;
  <span class="keywordflow">for</span> (uint i = 0; i &lt; callerList.size(); i++)
  {
    partListAsString = partListAsString 
      + <span class="stringliteral">&quot; &quot;</span> 
      + (<span class="keyword">const</span> <span class="keywordtype">char</span>*)callerList[i]-&gt;GetProp(<a name="a2"></a><a class="code" href="class_participant.html#a0789ec8e8c2faea38a444800004be26dae6efd49f53150606b810cd7caf6ba9a4">Participant::P_IDENTITY</a>);
  };

  <span class="comment">// re-loading with filter ALL, so that we get our own </span>
  <span class="comment">// Participant::P_SOUND_LEVEL updates as well</span>
  this-&gt;GetParticipants(callerList, <a name="a3"></a><a class="code" href="class_conversation.html#a3b9a94385c62856673e211120ea2ca7babbec81b22649fa4b551ba7d7b3a6cf1e">Conversation::ALL</a>);
  fetch(callerList);

  <span class="keywordflow">if</span> (!skype-&gt;isLiveSessionUp)
  {
    printf(<span class="stringliteral">&quot;Incoming call from: %s \n&quot;</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span>*)partListAsString);
    this-&gt;JoinLiveSession();
  }
  <span class="keywordflow">else</span>
  {
    printf(<span class="stringliteral">&quot;Another call is coming in from : %s \n&quot;</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span>*)partListAsString);
    printf(<span class="stringliteral">&quot;As we already have a live session up, we will reject it. \n&quot;</span>);
    this-&gt;LeaveLiveSession(<span class="keyword">true</span>);
  };
};
</pre></div><p>Now to the tricky part. To reliably catch an incoming calls, we actually need to detect two events: <a class="el" href="class_skype.html#a6e47d0fc195995491b449336010bd520">Skype::OnConversationListChange</a> and Conversation::OnChange property change callback.</p>
<p>The reason we need both is somewhat convoluted, but bear with me. If an incoming call occurs, what really happens from the wrapper perspective is that conversation object's LOCAL_LIVESTATUS property obtains a new value - RINGING_FOR_ME. However, there is no guarantee that the conversation object where this occured is already cached in the wrapper. Even if you have called methods or accessed properties of that particular conversation before, then unless you are keeping a <a class="el" href="class_conversation_ref.html" title="Reference to an Conversation class instance, equivalent to Conversation::Ref.">ConversationRef</a> pointing to that object in your code - the object has most likely been garbage collected. If the object is not in wrapper's object cache - you will not get property update events for that object.</p>
<p>So, unless you have references to every single conversation object, the only foolproof place to pick up calls would be <a class="el" href="class_skype.html#a6e47d0fc195995491b449336010bd520">Skype::OnConversationListChange</a> callback. This gets fired every time a conversation is added or removed from a conversation list. In this case, the object would be added to the <a class="el" href="class_conversation.html#a0eb196dd7006e1e37ba1c246c30d6183a0b24b475845c969751f905f569a3b63c">Conversation::LIVE_CONVERSATIONS</a>.</p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">void</span> MySkype::OnConversationListChange(
        <span class="keyword">const</span> <a name="_a4"></a><a class="code" href="class_conversation_ref.html" title="Reference to an Conversation class instance, equivalent to Conversation::Ref.">ConversationRef</a> &amp;conversation,
        <span class="keyword">const</span> <a class="code" href="class_conversation.html#a0eb196dd7006e1e37ba1c246c30d6183">Conversation::LIST_TYPE</a> &amp;type,
        <span class="keyword">const</span> <span class="keywordtype">bool</span> &amp;added)
{
  <span class="keywordflow">if</span> (type == <a name="a5"></a><a class="code" href="class_conversation.html#a0eb196dd7006e1e37ba1c246c30d6183a0b24b475845c969751f905f569a3b63c">Conversation::LIVE_CONVERSATIONS</a>)
  {
    <a class="code" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8f">Conversation::LOCAL_LIVESTATUS</a> liveStatus;
    conversation-&gt;GetPropLocalLivestatus(liveStatus);
    <a class="code" href="class_s_e_string.html" title="SEString is basic char* based string class.">SEString</a> liveStatusAsString = tostring(liveStatus);
    printf(<span class="stringliteral">&quot;OnConversationListChange : %s\n&quot;</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span>*)liveStatusAsString);

    <span class="keywordflow">if</span> (liveStatus == <a name="a6"></a><a class="code" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8fa123514d0921715cb2882899c32dd44fe">Conversation::RINGING_FOR_ME</a>)
    {
      printf(<span class="stringliteral">&quot;RING RING..\n&quot;</span>);
      printf(<span class="stringliteral">&quot;Picking up call from MySkype::OnConversationListChange\n&quot;</span>);
      <span class="comment">// Saving the currently live conversation reference..</span>
      liveSession = conversation-&gt;ref();
      liveSession.fetch();
      liveSession-&gt;PickUpCall();
    };
  };
};
</pre></div><p>The above method works really well. Until you come up against situation where you have more than one incoming calls in quick succession, from the same caller: one call comes in - you pick it up, call ends, another incoming call occurs. Then the method described above suddenly stops working.</p>
<p>The reason it stops working is that by default, formerly live conversations do not get removed from the LIVE_CONVERSATIONS list immediately. Instead they will linger on in that list for several additional seconds. This means that while the previously live conversation does that lingering, and if another call in the same conversation takes place - the OnConversationListChange event will not fire - because it didn't have time to get removed from that list in the first place.</p>
<p>However, we can now make sure that the conversation object is in wrapper's object cache, by keeping a reference to that object. So, now we can actually use the Conversation::OnChange callback and check for RINGING_FOR_ME.</p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">void</span> MyConversation::OnChange(<span class="keywordtype">int</span> prop)
{
  <span class="keywordflow">if</span> (prop == <a name="a7"></a><a class="code" href="class_conversation.html#a1fccc07009257810420d23e2174cad77a874a491d61fbfbfca75a722a4127502e">Conversation::P_LOCAL_LIVESTATUS</a>)
  {
    <a class="code" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8f">Conversation::LOCAL_LIVESTATUS</a> liveStatus;
    this-&gt;GetPropLocalLivestatus(liveStatus);
    <span class="keywordflow">if</span> (liveStatus == <a class="code" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8fa123514d0921715cb2882899c32dd44fe">Conversation::RINGING_FOR_ME</a>)
    {
      printf(<span class="stringliteral">&quot;RING RING..\n&quot;</span>);
      printf(<span class="stringliteral">&quot;Picking up call from MyConversation::OnChange\n&quot;</span>);
      this-&gt;PickUpCall();
    };

    <span class="keywordflow">if</span> (liveStatus == <a name="a8"></a><a class="code" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8fa32af02c79b904609c269e86f28a86bd8">Conversation::IM_LIVE</a>)
    {
      <span class="comment">// Saving the currently live conversation reference..</span>
      skype-&gt;liveSession = this-&gt;ref();
      printf(<span class="stringliteral">&quot;Live session is up.\n&quot;</span>);
    };

    <span class="keywordflow">if</span> ((liveStatus == <a name="a9"></a><a class="code" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8facd6e7d0bed121f4a6e47aae2f9fcfb13">Conversation::RECENTLY_LIVE</a>) || (liveStatus == <a name="a10"></a><a class="code" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8fab55c11dafb3e2691a44ec0bf554f84a7">Conversation::NONE</a>))
    {
      printf(<span class="stringliteral">&quot;Call has ended..\n&quot;</span>);
      skype-&gt;isLiveSessionUp = <span class="keyword">false</span>;
    };
  };
};
</pre></div><p>Alternative and somewhat simpler way to do all this would be to set the period that formerly live conversations stay in the recently live list to zero. This can be controlled modifying SETUPKEY_RECENTLY_LIVE_TIMEOUT like this: </p>
<div class="fragment"><pre class="fragment">skype-&gt;SetInt(<a name="a11"></a><a class="code" href="skype-embedded__2_8h.html#adb764df7242f46edf715e211582e0727">SETUPKEY_RECENTLY_LIVE_TIMEOUT</a>, 0);
</pre></div><p>Note that this is an account-based setup key, you can only access it after successful login.</p>
<p>We have now completed our first objective - the client is picking up incoming calls, refusing calls when one is already up, and displaying a notification when the call ends.</p>
<p>Our second objective was displaying voice activity events. For this we need to derive our own <a class="el" href="class_participant.html" title="Conversation participant class. Instances of this class represent contacts when in the context of con...">Participant</a> class and catch changes to the <a class="el" href="class_participant.html#a0789ec8e8c2faea38a444800004be26dae09cf97d97304778a53f913955d6bd4d">Participant::P_SOUND_LEVEL</a> property. This property can have integer values ranging from 0 to 10.</p>
<p>The customized <a class="el" href="class_participant.html" title="Conversation participant class. Instances of this class represent contacts when in the context of con...">Participant</a> class would looks like this: </p>
<div class="fragment"><pre class="fragment"><span class="keyword">class </span>MyParticipant : <span class="keyword">public</span> <a name="_a12"></a><a class="code" href="class_participant.html" title="Conversation participant class. Instances of this class represent contacts when in the context of con...">Participant</a>
{
<span class="keyword">public</span>:
  <span class="keyword">typedef</span> DRef&lt;MyParticipant, Participant&gt; Ref;
  <span class="keyword">typedef</span> DRefs&lt;MyParticipant, Participant&gt; Refs;
  MyParticipant(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> oid, SERootObject* root) : <a class="code" href="class_participant.html" title="Conversation participant class. Instances of this class represent contacts when in the context of con...">Participant</a>(oid, root) {};
  <span class="keywordtype">void</span> OnChange(<span class="keywordtype">int</span> prop);
};

<span class="keywordtype">void</span> MyParticipant::OnChange(<span class="keywordtype">int</span> prop)
{
  <span class="keywordflow">if</span> (prop == <a name="a13"></a><a class="code" href="class_participant.html#a0789ec8e8c2faea38a444800004be26dae09cf97d97304778a53f913955d6bd4d">Participant::P_SOUND_LEVEL</a>)
  {
    <a class="code" href="class_s_e_string.html" title="SEString is basic char* based string class.">SEString</a> name;
    uint soundLevel;
    GetPropIdentity(name);
    GetPropSoundLevel(soundLevel);
    printf(<span class="stringliteral">&quot;%s sound level = %d\n&quot;</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span>*)name, soundLevel);
  };
};
</pre></div><p>Note that this property change event fires only for remote participants - you will not get those events for your own voice activities.</p>
<p>To keep the MyParticipant::OnChange event firing reliably - you will need to have a list of references for your live conversation. Having just a MyConversation::Ref in your code for your live conversation is not enough. Participants objects in that conversation object may still get garbage collected. In case of this particular example, we are lucky - we are already retrieving the list of participants in our MyConversation::PickUpCall - to have it nicely printed out on screen. The only thing we need there is to keep that list of participants for entire duration of the call. Hence having the MyParticipant::Refs callerList - placed within MyConversation class.</p>
<p>Now onto selecting audio devices. Note that this part is not actually mandatory for picking up calls. However, it may happen that the SkypeKit audio engine fails to pick correct audio devices for you, so it makes sense to cover this topic here as well.</p>
<p>Firstly, there are three audio devices that the SkypeKit audio engine is interested in - output (speakers/headsets), input (microphone) and the PCM (or notification device). That one is basically an output device as well. It is used for various notification sounds, such as ringtones and other audible notification sounds. Having it separately enables you to have phone ringing on a different device from normal headset.</p>
<p>On your machine, there are two sorts of audio devices: audio in (microphones) and audio out (playback).</p>
<p>To query lists of those devices, there are two <a class="el" href="class_skype.html" title="The main class that exposes Skype-related functionality to your application. Currently the SDK only s...">Skype</a> class methods: GetAvailableOutputDevices and GetAvailableRecordingDevices. Both these return three SEStringLists.</p>
<ul>
<li>First of them is list of device handles. These can be used as arguments to other audio related commands, such as <a class="el" href="class_skype.html#a494bec4b1496140065202c946802b32c">Skype::SelectSoundDevices</a> </li>
<li>Second list will contain descriptive device name. </li>
<li>Third list contains product IDs, which can be in most cases safely ignored.</li>
</ul>
<p>After you have these lists, you can set all active audio devices for SkypeKit with just one command: <a class="el" href="class_skype.html#a494bec4b1496140065202c946802b32c">Skype::SelectSoundDevices</a>-</p>
<p>In code, this would look approximately like this: </p>
<div class="fragment"><pre class="fragment"><a name="_a14"></a><a class="code" href="class_s_e_string_list.html" title="SEStringList represents a list of strings (SEString objects).">SEStringList</a> outHandles, outNames, outProductIDs;
<a class="code" href="class_s_e_string_list.html" title="SEStringList represents a list of strings (SEString objects).">SEStringList</a> inHandles, inNames, inProductIDs;

printf(<span class="stringliteral">&quot;** Playback devices:\n&quot;</span>);
skype-&gt;GetAvailableOutputDevices (outHandles, outNames, outProductIDs);
<span class="keywordflow">for</span> (uint i = 0; i &lt; outHandles.<a name="a15"></a><a class="code" href="class_s_e_string_list.html#a0f86fa4676e6bea28f9923955a503360">size</a>(); i++)
{
  printf(<span class="stringliteral">&quot;%4d. %s\n&quot;</span>, i, (<span class="keyword">const</span> <span class="keywordtype">char</span>*)outNames[i]);
};

<span class="comment">// Getting a list of audio input devices.</span>
printf(<span class="stringliteral">&quot;\n** Recording devices:\n&quot;</span>);
skype-&gt;GetAvailableRecordingDevices (inHandles, inNames, inProductIDs);
<span class="keywordflow">for</span> (uint i = 0; i &lt; inHandles.<a class="code" href="class_s_e_string_list.html#a0f86fa4676e6bea28f9923955a503360">size</a>(); i++)
{
    printf(<span class="stringliteral">&quot;%4d. %s\n&quot;</span>, i, (<span class="keyword">const</span> <span class="keywordtype">char</span>*)inNames[i]);
};

uint inputDeviceIdx   = 0;
uint outputDeviceIdx  = 0;

skype-&gt;SelectSoundDevices(
  inHandles[inputDeviceIdx], 
  outHandles[outputDeviceIdx], 
  outHandles[outputDeviceIdx]);
</pre></div><h2><a class="anchor" id="Step5FullCode"></a>
Full code of this example</h2>
<div class="fragment"><pre class="fragment"><span class="comment">/****************************************************************************</span>
<span class="comment"></span>
<span class="comment">Getting Started With SkypeKit. Tutorial Application, Step 5.</span>
<span class="comment"></span>
<span class="comment">In this step of the tutorial, we finally get around to voice calls. We&#39;ll write a small SkypeKit client that</span>
<span class="comment">  * waits for incoming calls</span>
<span class="comment">  * picks them up</span>
<span class="comment">  * if there&#39;s audio coming in from any of the remote parties, prints audio volume levels</span>
<span class="comment"></span>
<span class="comment">**/</span>

<span class="preprocessor">#include &quot;<a class="code" href="skype-embedded__2_8h.html">skype-embedded_2.h</a>&quot;</span>
<span class="preprocessor">#include &quot;keypair.h&quot;</span>
<span class="preprocessor">#include &quot;tutorial_common.h&quot;</span>

<span class="keyword">using namespace </span>Sid;

<a class="code" href="class_s_e_string.html" title="SEString is basic char* based string class.">SEString</a> myAccountName;
<a class="code" href="class_s_e_string.html" title="SEString is basic char* based string class.">SEString</a> myAccountPsw;

<span class="comment">//----------------------------------------------------------------------------</span>
<span class="comment">// Interface section</span>

<span class="keyword">class </span>MyParticipant : <span class="keyword">public</span> <a class="code" href="class_participant.html" title="Conversation participant class. Instances of this class represent contacts when in the context of con...">Participant</a>
{
<span class="keyword">public</span>:
  <span class="keyword">typedef</span> DRef&lt;MyParticipant, Participant&gt; Ref;
  <span class="keyword">typedef</span> DRefs&lt;MyParticipant, Participant&gt; Refs;
  MyParticipant(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> oid, SERootObject* root) : <a class="code" href="class_participant.html" title="Conversation participant class. Instances of this class represent contacts when in the context of con...">Participant</a>(oid, root) {};

  <span class="keywordtype">void</span> OnChange(<span class="keywordtype">int</span> prop);
};

<span class="keyword">class </span>MyConversation : <span class="keyword">public</span> <a name="_a16"></a><a class="code" href="class_conversation.html" title="The Conversation class encapsulates all types of communication possible with Skype client...">Conversation</a>
{
<span class="keyword">public</span>:
  <span class="keyword">typedef</span> DRef&lt;MyConversation, Conversation&gt; Ref;
  <span class="keyword">typedef</span> DRefs&lt;MyConversation, Conversation&gt; Refs;  
  MyConversation(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> oid, SERootObject* root) : <a class="code" href="class_conversation.html" title="The Conversation class encapsulates all types of communication possible with Skype client...">Conversation</a>(oid, root) {};

  MyParticipant::Refs callerList;

  <span class="keywordtype">void</span> OnChange(<span class="keywordtype">int</span> prop);
  <span class="keywordtype">void</span> PickUpCall();
};

<span class="keyword">class </span>MySkype : <span class="keyword">public</span> <a name="_a17"></a><a class="code" href="class_skype.html" title="The main class that exposes Skype-related functionality to your application. Currently the SDK only s...">Skype</a>
{
<span class="keyword">public</span>:
  <span class="keywordtype">bool</span> isLiveSessionUp;
  MyConversation::Ref liveSession;
  MySkype();

  <a name="_a18"></a><a class="code" href="class_account.html" title="Represents a local account. Encapsulates methods for Skype account creation, login and logout as well...">Account</a>*      newAccount(<span class="keywordtype">int</span> oid) { <span class="keywordflow">return</span> <span class="keyword">new</span> MyAccount(oid, <span class="keyword">this</span>); };
  <a class="code" href="class_participant.html" title="Conversation participant class. Instances of this class represent contacts when in the context of con...">Participant</a>*  newParticipant(<span class="keywordtype">int</span> oid) { <span class="keywordflow">return</span> <span class="keyword">new</span> MyParticipant(oid, <span class="keyword">this</span>); };
  <a class="code" href="class_conversation.html" title="The Conversation class encapsulates all types of communication possible with Skype client...">Conversation</a>* newConversation(<span class="keywordtype">int</span> oid) { <span class="keywordflow">return</span> <span class="keyword">new</span> MyConversation(oid, <span class="keyword">this</span>); };

    <span class="keywordtype">void</span> OnConversationListChange(
        <span class="keyword">const</span> <a class="code" href="class_conversation_ref.html" title="Reference to an Conversation class instance, equivalent to Conversation::Ref.">ConversationRef</a> &amp;conversation,
        <span class="keyword">const</span> <a class="code" href="class_conversation.html#a0eb196dd7006e1e37ba1c246c30d6183">Conversation::LIST_TYPE</a> &amp;type,
        <span class="keyword">const</span> <span class="keywordtype">bool</span> &amp;added);
};

MySkype* skype;

<span class="comment">//----------------------------------------------------------------------------</span>
<span class="comment">// Implementation section</span>

<span class="keywordtype">void</span> MyParticipant::OnChange(<span class="keywordtype">int</span> prop)
{
  <span class="keywordflow">if</span> (prop == <a class="code" href="class_participant.html#a0789ec8e8c2faea38a444800004be26dae09cf97d97304778a53f913955d6bd4d">Participant::P_SOUND_LEVEL</a>)
  {
    <a class="code" href="class_s_e_string.html" title="SEString is basic char* based string class.">SEString</a> name;
    uint soundLevel;
    GetPropIdentity(name);
    GetPropSoundLevel(soundLevel);
    printf(<span class="stringliteral">&quot;%s sound level = %d\n&quot;</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span>*)name, soundLevel);
  };
};

<span class="keywordtype">void</span> MyConversation::PickUpCall()
{
  <span class="comment">// CallerList we keep in Conversation class - so that it won&#39;t get garbage collected</span>
  <span class="comment">// while the conversation object exists in the wrapper. </span>
  this-&gt;GetParticipants(callerList, <a class="code" href="class_conversation.html#a3b9a94385c62856673e211120ea2ca7badaf9ba258a630895b4eb1055ad619adf">Conversation::OTHER_CONSUMERS</a>);
  <a class="code" href="class_s_e_string.html" title="SEString is basic char* based string class.">SEString</a> partListAsString = <span class="stringliteral">&quot;&quot;</span>;
  <span class="keywordflow">for</span> (uint i = 0; i &lt; callerList.size(); i++)
  {
    partListAsString = partListAsString 
      + <span class="stringliteral">&quot; &quot;</span> 
      + (<span class="keyword">const</span> <span class="keywordtype">char</span>*)callerList[i]-&gt;GetProp(<a class="code" href="class_participant.html#a0789ec8e8c2faea38a444800004be26dae6efd49f53150606b810cd7caf6ba9a4">Participant::P_IDENTITY</a>);
  };

  <span class="comment">// re-loading with filter ALL, so that we get our own </span>
  <span class="comment">// Participant::P_SOUND_LEVEL updates as well</span>
  this-&gt;GetParticipants(callerList, <a class="code" href="class_conversation.html#a3b9a94385c62856673e211120ea2ca7babbec81b22649fa4b551ba7d7b3a6cf1e">Conversation::ALL</a>);
  fetch(callerList);


  <span class="keywordflow">if</span> (!skype-&gt;isLiveSessionUp)
  {
    printf(<span class="stringliteral">&quot;Incoming call from: %s \n&quot;</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span>*)partListAsString);
    this-&gt;JoinLiveSession();
  }
  <span class="keywordflow">else</span>
  {
    printf(<span class="stringliteral">&quot;Another call is coming in from : %s \n&quot;</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span>*)partListAsString);
    printf(<span class="stringliteral">&quot;As we already have a live session up, we will reject it. \n&quot;</span>);
    this-&gt;LeaveLiveSession(<span class="keyword">true</span>);
  };
};

<span class="keywordtype">void</span> MyConversation::OnChange(<span class="keywordtype">int</span> prop)
{
  <span class="keywordflow">if</span> (prop == <a class="code" href="class_conversation.html#a1fccc07009257810420d23e2174cad77a874a491d61fbfbfca75a722a4127502e">Conversation::P_LOCAL_LIVESTATUS</a>)
  {
    <a class="code" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8f">Conversation::LOCAL_LIVESTATUS</a> liveStatus;
    this-&gt;GetPropLocalLivestatus(liveStatus);
    <span class="keywordflow">if</span> (liveStatus == <a class="code" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8fa123514d0921715cb2882899c32dd44fe">Conversation::RINGING_FOR_ME</a>)
    {
      printf(<span class="stringliteral">&quot;RING RING..\n&quot;</span>);
      printf(<span class="stringliteral">&quot;Picking up call from MyConversation::OnChange\n&quot;</span>);
      this-&gt;PickUpCall();
    };

    <span class="keywordflow">if</span> (liveStatus == <a class="code" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8fa32af02c79b904609c269e86f28a86bd8">Conversation::IM_LIVE</a>)
    {
      <span class="comment">// Saving the currently live conversation reference..</span>
      skype-&gt;liveSession = this-&gt;ref();
      printf(<span class="stringliteral">&quot;Live session is up.\n&quot;</span>);
    };

    <span class="keywordflow">if</span> ((liveStatus == <a class="code" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8facd6e7d0bed121f4a6e47aae2f9fcfb13">Conversation::RECENTLY_LIVE</a>) || (liveStatus == <a class="code" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8fab55c11dafb3e2691a44ec0bf554f84a7">Conversation::NONE</a>))
    {
      printf(<span class="stringliteral">&quot;Call has ended..\n&quot;</span>);
      skype-&gt;isLiveSessionUp = <span class="keyword">false</span>;
    };
  };
};

<span class="comment">//----------------------------------------------------------------------------</span>
<span class="comment">// Subclassing Skype</span>

MySkype::MySkype() : <a class="code" href="class_skype.html" title="The main class that exposes Skype-related functionality to your application. Currently the SDK only s...">Skype</a>() 
{ 
  isLiveSessionUp   = <span class="keyword">false</span>;
  liveSession       = 0;
};

<span class="keywordtype">void</span> <a name="a19"></a><a class="code" href="class_skype.html#a6e47d0fc195995491b449336010bd520">MySkype::OnConversationListChange</a>(
        <span class="keyword">const</span> <a class="code" href="class_conversation_ref.html" title="Reference to an Conversation class instance, equivalent to Conversation::Ref.">ConversationRef</a> &amp;conversation,
        <span class="keyword">const</span> <a class="code" href="class_conversation.html#a0eb196dd7006e1e37ba1c246c30d6183">Conversation::LIST_TYPE</a> &amp;type,
        <span class="keyword">const</span> <span class="keywordtype">bool</span> &amp;added)
{
  <span class="keywordflow">if</span> (type == <a class="code" href="class_conversation.html#a0eb196dd7006e1e37ba1c246c30d6183a0b24b475845c969751f905f569a3b63c">Conversation::LIVE_CONVERSATIONS</a>)
  {
    <a class="code" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8f">Conversation::LOCAL_LIVESTATUS</a> liveStatus;
    conversation-&gt;GetPropLocalLivestatus(liveStatus);
    <a class="code" href="class_s_e_string.html" title="SEString is basic char* based string class.">SEString</a> liveStatusAsString = tostring(liveStatus);
    printf(<span class="stringliteral">&quot;OnConversationListChange : %s\n&quot;</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span>*)liveStatusAsString);

    <span class="keywordflow">if</span> (liveStatus == <a class="code" href="class_conversation.html#a65f54d9d78c06e3164b73cbba8df0f8fa123514d0921715cb2882899c32dd44fe">Conversation::RINGING_FOR_ME</a>)
    {
      printf(<span class="stringliteral">&quot;RING RING..\n&quot;</span>);
      printf(<span class="stringliteral">&quot;Picking up call from MySkype::OnConversationListChange\n&quot;</span>);
      <span class="comment">// Saving the currently live conversation reference..</span>
      liveSession = conversation-&gt;ref();
      liveSession.fetch();
      liveSession-&gt;PickUpCall();
    };
  };
};

<span class="comment">//----------------------------------------------------------------------------</span>
<span class="comment">// Main</span>

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * argv[])
{
  printf(<span class="stringliteral">&quot;*****************************************************************\n&quot;</span>);
  printf(<span class="stringliteral">&quot; SkypeKit Tutorial, Step 5. - Answering incoming audio calls.\n&quot;</span>);
  printf(<span class="stringliteral">&quot;*****************************************************************\n&quot;</span>);

  <span class="keywordflow">if</span> (argc &lt; 3)
  {
    printf(<span class="stringliteral">&quot;usage: tutorial_5 &lt;skypename&gt; &lt;password&gt; [mic idx] [playback idx]\n&quot;</span>);
    <span class="keywordflow">return</span> 0;
  };

  myAccountName   = argv[1];
  myAccountPsw    = argv[2];

  uint inputDeviceIdx   = 0;
  uint outputDeviceIdx  = 0;
  <span class="keywordflow">if</span> (argc &gt; 3) { inputDeviceIdx = atoi(argv[3]); };
  <span class="keywordflow">if</span> (argc &gt; 4) { outputDeviceIdx = atoi(argv[4]); };

  printf(<span class="stringliteral">&quot;Creating skype ..\n&quot;</span>);
  skype = <span class="keyword">new</span> MySkype();

  printf(<span class="stringliteral">&quot;Submitting application token..\n&quot;</span>);
  getKeyPair ();
  skype-&gt;init(keyBuf, inetAddr, portNum, <span class="stringliteral">&quot;streamlog.txt&quot;</span>);
  skype-&gt;start();

  printf(<span class="stringliteral">&quot;Retrieving account ..\n&quot;</span>);
  MyAccount::Ref account;

  <span class="keywordflow">if</span> (skype-&gt;GetAccount(myAccountName, account))
  {
    printf(<span class="stringliteral">&quot;Logging in..\n&quot;</span>);
    account-&gt;LoginWithPassword(myAccountPsw, <span class="keyword">false</span>, <span class="keyword">true</span>);
    account-&gt;BlockWhileLoggingIn();

    <span class="keywordflow">if</span> (account-&gt;loggedIn)
    {
      printf(<span class="stringliteral">&quot;Loggin complete.\n&quot;</span>);

      <span class="keywordtype">int</span> recentlyLiveTimeout;
      skype-&gt;GetInt(<a class="code" href="skype-embedded__2_8h.html#adb764df7242f46edf715e211582e0727">SETUPKEY_RECENTLY_LIVE_TIMEOUT</a>, recentlyLiveTimeout);
      printf(<span class="stringliteral">&quot;Conversation recently live timeout: %d seconds.\n&quot;</span>, recentlyLiveTimeout);
    
      <span class="comment">// Alternative way to get around having to pick up calls </span>
      <span class="comment">// from two different callbacks:</span>
      <span class="comment">//skype-&gt;SetInt(SETUPKEY_RECENTLY_LIVE_TIMEOUT, 0);</span>
    
      <span class="comment">// ** Setting up audio devices **</span>
      <span class="comment">// First, getting a list of audio devices. There are two separate commands:</span>
      <span class="comment">// Skype::GetAvailableOutputDevices and Skype-&gt;GetAvailableRecordingDevices</span>
      <span class="comment">// Both retrurn three SEStringLists.</span>
      <span class="comment">// 1. First of them is list of device handles. These can be used as arguments</span>
      <span class="comment">// to other audio related commands, such as Skype::SelectSoundDevices</span>
      <span class="comment">// 2. Second list will contain descriptive device name.</span>
      <span class="comment">// 3. Third list contains product IDs, which can be in most cases safely ignored.</span>

      <a class="code" href="class_s_e_string_list.html" title="SEStringList represents a list of strings (SEString objects).">SEStringList</a> outHandles, outNames, outProductIDs;
      <a class="code" href="class_s_e_string_list.html" title="SEStringList represents a list of strings (SEString objects).">SEStringList</a> inHandles, inNames, inProductIDs;

      printf(<span class="stringliteral">&quot;** Playback devices:\n&quot;</span>);
      skype-&gt;GetAvailableOutputDevices (outHandles, outNames, outProductIDs);
      <span class="keywordflow">for</span> (uint i = 0; i &lt; outHandles.<a class="code" href="class_s_e_string_list.html#a0f86fa4676e6bea28f9923955a503360">size</a>(); i++)
      {
        printf(<span class="stringliteral">&quot;%4d. %s\n&quot;</span>, i, (<span class="keyword">const</span> <span class="keywordtype">char</span>*)outNames[i]);
      };

      <span class="comment">// Getting a list of audio input devices.</span>
      printf(<span class="stringliteral">&quot;\n** Recording devices:\n&quot;</span>);
      skype-&gt;GetAvailableRecordingDevices (inHandles, inNames, inProductIDs);
      <span class="keywordflow">for</span> (uint i = 0; i &lt; inHandles.<a class="code" href="class_s_e_string_list.html#a0f86fa4676e6bea28f9923955a503360">size</a>(); i++)
      {
          printf(<span class="stringliteral">&quot;%4d. %s\n&quot;</span>, i, (<span class="keyword">const</span> <span class="keywordtype">char</span>*)inNames[i]);
      };

      skype-&gt;SelectSoundDevices(
        inHandles[inputDeviceIdx], 
        outHandles[outputDeviceIdx], 
        outHandles[outputDeviceIdx]);

      skype-&gt;SetSpeakerVolume(100);

      printf(<span class="stringliteral">&quot;Now accepting incoming calls..\n&quot;</span>);
      printf(<span class="stringliteral">&quot;Press ENTER to quit.\n&quot;</span>);
      getchar();

      printf(<span class="stringliteral">&quot;Logging out..\n&quot;</span>);
      account-&gt;Logout(<span class="keyword">false</span>);
      account-&gt;BlockWhileLoggingOut();
      printf(<span class="stringliteral">&quot;Logout complete.\n&quot;</span>);
    };
  }
  <span class="keywordflow">else</span>
  {
    printf(<span class="stringliteral">&quot;Account does not exist\n&quot;</span>);
  };

  printf(<span class="stringliteral">&quot;Cleaning up.\n&quot;</span>);
  skype-&gt;stop();
  <span class="keyword">delete</span> skype;
  printf(<span class="stringliteral">&quot;Done.\n&quot;</span>);
  <span class="keywordflow">return</span> 0;
};
</pre></div> </div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


<hr/>	
		<p><b>(c) Skype Technologies S.A. Confidential/Proprietary</b></p>		
		<p>Last updated: Fri Oct 7 2011</p>		
		</BODY>
</HTML>
